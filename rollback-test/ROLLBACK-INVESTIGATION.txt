================================================================================
                    SNAP ROLLBACK INVESTIGATION REPORT
================================================================================
Date: 2026-02-09 / 2026-02-10
Purpose: Understand what triggers snap rollback during refresh/update
Customer Use Case: Firmware update taking >10 minutes in post-refresh hook

================================================================================
                              EXECUTIVE SUMMARY
================================================================================

WHAT TRIGGERS ROLLBACK:
  - post-refresh hook failure       -> ROLLBACK
  - post-refresh hook timeout       -> ROLLBACK
  - oneshot daemon failure          -> ROLLBACK
  - oneshot daemon timeout          -> ROLLBACK
  - Long-running oneshot failure    -> ROLLBACK (even after 15+ minutes)

WHAT DOES NOT TRIGGER ROLLBACK:
  - pre-refresh hook failure        -> ABORT (no rollback needed)
  - simple daemon failure           -> NO ROLLBACK (service just restarts)
  - simple daemon crash later       -> NO ROLLBACK (service restarts)

KEY FINDING FOR CUSTOMER:
  Move firmware update from post-refresh hook to ONESHOT DAEMON with
  extended start-timeout. Failure will trigger rollback even after
  15+ minutes of execution.

================================================================================
                              TEST RESULTS
================================================================================

TEST 1: Post-refresh Hook Failure
---------------------------------
Setup:    snap set rollback-test post-refresh-fail=true
Action:   Installed new version (2.1)
Result:   ROLLBACK to version 2.0
Time:     ~2-3 seconds
Evidence:
  - error: cannot perform the following tasks:
    - Run post-refresh hook of "rollback-test" snap if present
      (run hook "post-refresh": exit status 1)
  - snap info showed version remained at 2.0

Log excerpt:
  [2026-02-09 15:36:57.837] === PRE-REFRESH HOOK ===
  [2026-02-09 15:36:57.837] Pre-refresh hook passed
  [2026-02-09 15:37:00.088] === POST-REFRESH HOOK ===
  [2026-02-09 15:37:00.088] POST-REFRESH HOOK FAILING
  [2026-02-09 15:37:00.088] Result: Snap will be ROLLED BACK


TEST 2: Pre-refresh Hook Failure
--------------------------------
Setup:    snap set rollback-test pre-refresh-fail=true
Action:   Attempted to install new version (2.2)
Result:   ABORT (refresh never happened, stayed on current version)
Time:     Immediate
Note:     This is NOT a rollback - the refresh is simply cancelled before
          any changes are made.


TEST 3: Oneshot Daemon Failure (Quick)
--------------------------------------
Setup:    snap set rollback-test oneshot-fail=true
Action:   Installed new version (2.3)
Result:   ROLLBACK to version 2.0
Time:     ~3 seconds
Evidence:
  - error: cannot perform the following tasks:
    - Stop snap "rollback-test" services (systemctl command
      [start snap.rollback-test.oneshot.service] failed with exit status 1)
  - snap info showed version rolled back to 2.0

Log excerpt:
  [2026-02-09 15:42:05.539] ========== ONESHOT DAEMON STARTED ==========
  [2026-02-09 15:42:05.539] SNAP_VERSION=2.3
  [2026-02-09 15:42:05.539] SNAP_REVISION=x2
  [2026-02-09 15:42:05.539] ONESHOT FAILING AS CONFIGURED
  [2026-02-09 15:42:05.539] Exiting with code 1
  [2026-02-09 15:42:08.816] ========== ONESHOT DAEMON STARTED ==========
  [2026-02-09 15:42:08.816] SNAP_VERSION=2.0  <-- Rolled back!
  [2026-02-09 15:42:08.816] SNAP_REVISION=x1

IMPORTANT: Config persists in $SNAP_COMMON, so after rollback the oneshot
           still fails. Must reset config: snap set rollback-test oneshot-fail=false


TEST 4: Simple Daemon Failure
-----------------------------
Setup:    snap set rollback-test service-fail=true
Action:   Installed new version (2.5)
Result:   NO ROLLBACK - snap installed successfully to 2.5
Time:     N/A (no rollback occurred)
Evidence:
  - rollback-test 2.5 installed
  - snap info showed version 2.5
  - Service failed but snap remained at new version

Log excerpt:
  [2026-02-09 15:46:46.895] service-fail config: 'true'
  [2026-02-09 15:46:46.895] SERVICE FAILING AS CONFIGURED
  [2026-02-09 15:46:46.895] Exiting with code 1

CONCLUSION: Simple daemon failures do NOT trigger rollback. The snap
            installs successfully and the service just keeps restarting.


TEST 5: Long-Running Oneshot SUCCESS (15 minutes)
-------------------------------------------------
Setup:    snap set rollback-test firmware-delay=900
          snap set rollback-test firmware-fail=false
          snapcraft.yaml: start-timeout: 20m
Action:   Installed new version (5.0)
Result:   SUCCESS - snap installed after 15 minutes
Time:     15 minutes (900 seconds)
Evidence:
  - Oneshot started at 20:32:43
  - Oneshot completed at 20:47:43 (exactly 15 minutes later)
  - Exit code: SUCCESS
  - Snap remained at version 5.0

Log excerpt:
  [2026-02-09 20:32:43.777] ========== FIRMWARE UPDATER STARTED ==========
  [2026-02-09 20:32:43.777] SNAP_VERSION=5.0
  [2026-02-09 20:32:43.777] firmware-delay: '900' seconds
  [2026-02-09 20:32:43.777] Starting firmware update...
  [2026-02-09 20:32:43.777] (Sleeping for 900 seconds to simulate flash)
  [2026-02-09 20:47:43.793] Firmware update completed successfully

CONCLUSION: With extended start-timeout (20m), a 15-minute oneshot can
            complete successfully without timing out.


TEST 6: Long-Running Oneshot FAILURE (15 minutes) - CRITICAL TEST
-----------------------------------------------------------------
Setup:    snap set rollback-test firmware-delay=900
          snap set rollback-test firmware-fail=true
          snapcraft.yaml: start-timeout: 20m
Action:   Installed new version (5.1)
Result:   ROLLBACK to version 5.0 after 15 minutes
Time:     15 minutes (900 seconds) before failure/rollback
Evidence:
  - v5.1 oneshot started at 09:49:28
  - v5.1 oneshot ran for 15 minutes
  - v5.1 oneshot FAILED at 10:04:28
  - Snap ROLLED BACK to v5.0
  - v5.0 oneshot started at 10:04:32 (4 seconds after rollback)

Log excerpt:
  [2026-02-10 09:49:28.281] ========== FIRMWARE UPDATER STARTED ==========
  [2026-02-10 09:49:28.281] SNAP_VERSION=5.1
  [2026-02-10 09:49:28.281] SNAP_REVISION=x2
  [2026-02-10 09:49:28.281] firmware-fail: 'true'
  [2026-02-10 09:49:28.281] firmware-delay: '900' seconds
  [2026-02-10 09:49:28.281] Starting firmware update...
  [2026-02-10 09:49:28.281] (Sleeping for 900 seconds to simulate flash)
  [2026-02-10 10:04:28.300] FIRMWARE UPDATE FAILED!
  [2026-02-10 10:04:28.300] This will trigger SNAP ROLLBACK
  [2026-02-10 10:04:32.828] ========== FIRMWARE UPDATER STARTED ==========
  [2026-02-10 10:04:32.828] SNAP_VERSION=5.0  <-- ROLLED BACK!
  [2026-02-10 10:04:32.828] SNAP_REVISION=x1

Journal excerpt:
  Feb 10 09:49:28 systemd[1]: Starting snap.rollback-test.firmware-updater.service
  Feb 10 10:04:28 systemd[1]: snap.rollback-test.firmware-updater.service:
                              Main process exited, code=exited, status=1/FAILURE
  Feb 10 10:04:28 systemd[1]: Failed to start snap.rollback-test.firmware-updater.service
  Feb 10 10:04:32 systemd[1]: Starting snap.rollback-test.firmware-updater.service
                              (this is v5.0 after rollback)

CONCLUSION: A 15-minute oneshot that FAILS at the end DOES trigger rollback.
            This is the KEY FINDING for the customer's firmware update use case.


================================================================================
                         TIMING ANALYSIS
================================================================================

Event                          | Approximate Time
-------------------------------|------------------
pre-refresh hook execution     | Immediate
post-refresh hook execution    | ~2-3 sec after pre-refresh
Oneshot daemon start           | During service activation
Quick failure detection        | ~1-2 sec after failure
Quick rollback completion      | ~3 sec total from failure
15-min oneshot execution       | 900 seconds (exact)
15-min failure detection       | Immediate after exit code 1
15-min rollback completion     | ~4 sec after failure detected

Default Timeouts:
  - Hook timeout:              ~10 minutes (snapd default)
  - Oneshot service timeout:   ~90 seconds (systemd default)
  - Extended timeout:          Configurable via start-timeout in snapcraft.yaml


================================================================================
                    ROLLBACK BEHAVIOR MATRIX
================================================================================

+---------------------------+----------+------------------+----------------------+
| Failure Point             | Rollback | Snap Version     | Services After       |
+---------------------------+----------+------------------+----------------------+
| pre-refresh hook          | NO*      | Stays at current | Unchanged            |
| post-refresh hook         | YES      | Reverts to prev  | Restarted (prev ver) |
| oneshot daemon (quick)    | YES      | Reverts to prev  | May be disabled**    |
| oneshot daemon (15 min)   | YES      | Reverts to prev  | May be disabled**    |
| simple daemon             | NO       | Stays at new     | Keeps restarting     |
| health check (if conf)    | YES      | Reverts to prev  | Restarted (prev ver) |
+---------------------------+----------+------------------+----------------------+

* pre-refresh failure = ABORT, not rollback (refresh never started)
** Services may be disabled if config persists and causes repeated failures


================================================================================
                    EXTENDING ONESHOT TIMEOUT
================================================================================

Default systemd timeout for oneshot is ~90 seconds. For long-running
operations like firmware updates, extend using start-timeout in snapcraft.yaml:

  apps:
    firmware-updater:
      command: bin/update-firmware.sh
      daemon: oneshot
      start-timeout: 20m  # 20 minutes

TESTED AND VERIFIED:
  - 15-minute oneshot with 20-minute timeout: SUCCESS (completes normally)
  - 15-minute oneshot with 20-minute timeout + failure: ROLLBACK

Alternative: Systemd override (if snap doesn't support start-timeout):

  mkdir -p /etc/systemd/system/snap.SNAPNAME.firmware-updater.service.d/
  cat > /etc/systemd/system/snap.SNAPNAME.firmware-updater.service.d/override.conf << EOF
  [Service]
  TimeoutStartSec=1800  # 30 minutes
  EOF
  systemctl daemon-reload


================================================================================
                    CUSTOMER USE CASE: FIRMWARE UPDATE
================================================================================

PROBLEM:
  Customer has firmware update in post-refresh hook that takes >10 minutes.
  Hook times out at ~10 minutes, causing unwanted failure.
  Customer needs: long-running operation that triggers rollback on failure.

SOLUTION:
  Move firmware update to ONESHOT daemon with extended start-timeout.

WHY ONESHOT WORKS (PROVEN BY TESTING):
  1. Oneshot runs during service activation phase
  2. Has configurable timeout via start-timeout (tested with 20m)
  3. 15-minute operation completes successfully (tested)
  4. 15-minute operation that FAILS triggers ROLLBACK (tested)
  5. Rollback happens even after 15 minutes of execution (tested)

IMPLEMENTATION:

  snapcraft.yaml:
  ---------------
  apps:
    firmware-updater:
      command: bin/update-firmware.sh
      daemon: oneshot
      start-timeout: 20m  # Longer than max expected firmware flash time

  bin/update-firmware.sh:
  -----------------------
  #!/bin/bash
  # Flash firmware - takes ~15 minutes
  flash_firmware

  # Verify firmware - if this fails, snap will rollback
  if ! verify_firmware; then
      echo "Firmware verification failed!"
      exit 1  # This triggers rollback
  fi

  exit 0  # Success - snap stays at new version

BEHAVIOR:
  - Firmware flash succeeds  -> Snap installed at new version
  - Firmware flash fails     -> Snap ROLLS BACK to previous version
  - Firmware flash times out -> Snap ROLLS BACK (if exceeds start-timeout)


================================================================================
                    HOOK EXECUTION ORDER
================================================================================

During snap refresh:

1. pre-refresh hook (OLD snap)
   - Can ABORT refresh (exit non-zero)
   - Runs before any files are changed

2. Snap files are updated
   - Old revision preserved for potential rollback

3. post-refresh hook (NEW snap)
   - Can trigger ROLLBACK (exit non-zero)
   - Runs after files updated but before services start

4. Services stopped (old)

5. Services started (new)
   - Oneshot daemons run first (based on 'after' ordering)
   - If oneshot fails -> ROLLBACK
   - Simple daemons start
   - If simple daemon fails -> NO rollback (just restarts)

6. configure hook (if config changed)


================================================================================
                    KEY TAKEAWAYS
================================================================================

1. ONESHOT DAEMON FAILURE = ROLLBACK
   Use oneshot for critical operations that must succeed for snap to work.
   PROVEN: Even after 15 minutes, failure triggers rollback.

2. SIMPLE DAEMON FAILURE = NO ROLLBACK
   Use simple for services that can fail/restart without affecting snap state.

3. POST-REFRESH HOOK FAILURE = ROLLBACK
   Good for quick validation, but has ~10 min timeout limit.
   NOT suitable for long-running operations like firmware flash.

4. PRE-REFRESH HOOK FAILURE = ABORT
   Good for pre-flight checks before allowing refresh.

5. CONFIG PERSISTS ACROSS ROLLBACK
   $SNAP_COMMON survives rollback - be careful with failure flags!

6. SERVICE ORDERING MATTERS
   Use 'after' in snapcraft.yaml to control startup order.

7. EXTENDED TIMEOUT WORKS
   start-timeout: 20m allows 15-minute operations to complete.
   Tested and verified with both success and failure scenarios.


================================================================================
                    TEST SNAP STRUCTURE
================================================================================

rollback-test/
├── bin/
│   ├── firmware-updater.sh    # Oneshot - failure triggers rollback (tested 15min)
│   ├── database.sh            # Simple daemon - failure = no rollback
│   ├── webui.sh               # Simple daemon - depends on database
│   ├── oneshot.sh             # Generic oneshot test
│   ├── service.sh             # Generic simple daemon test
│   ├── status.sh              # Show current state
│   ├── check-logs.sh          # View all logs
│   ├── trigger-fail.sh        # Configure failure scenarios
│   └── health-check.sh        # Health check test
├── snap/
│   ├── snapcraft.yaml         # Includes start-timeout: 20m
│   └── hooks/
│       ├── install            # Initialize config
│       ├── configure          # Handle config changes
│       ├── pre-refresh        # Pre-refresh validation
│       └── post-refresh       # Post-refresh validation
├── README.md
└── ROLLBACK-INVESTIGATION.txt # This file


CONFIGURATION OPTIONS:
  snap set rollback-test firmware-fail=true      # Oneshot fails -> ROLLBACK
  snap set rollback-test firmware-delay=900      # 15-minute delay (tested)
  snap set rollback-test database-fail=true      # Simple daemon fails -> NO rollback
  snap set rollback-test webui-fail=true         # Simple daemon fails -> NO rollback
  snap set rollback-test pre-refresh-fail=true   # Hook fails -> ABORT
  snap set rollback-test post-refresh-fail=true  # Hook fails -> ROLLBACK
  snap set rollback-test oneshot-fail=true       # Oneshot fails -> ROLLBACK
  snap set rollback-test service-fail=true       # Simple fails -> NO rollback


================================================================================
                    COMMANDS USED FOR TESTING
================================================================================

# Build snap
snapcraft pack --use-lxd

# Install snap
sudo snap install --dangerous rollback-test_X.X_amd64.snap

# Remove snap (with purge to clear config)
sudo snap remove --purge rollback-test

# Check version
snap info rollback-test | grep installed

# Check services
snap services rollback-test

# View changes/history
snap changes
snap change <id>

# View logs
sudo cat /var/snap/rollback-test/common/hooks.log
sudo cat /var/snap/rollback-test/common/firmware.log
sudo cat /var/snap/rollback-test/common/oneshot.log
sudo cat /var/snap/rollback-test/common/service.log
sudo cat /var/snap/rollback-test/common/database.log
sudo cat /var/snap/rollback-test/common/webui.log

# Or use helpers
sudo rollback-test.check-logs
sudo rollback-test.status

# Configure failure
sudo snap set rollback-test <option>=true
sudo rollback-test.trigger-fail <scenario>
sudo rollback-test.trigger-fail reset

# System logs
sudo journalctl -u snapd | grep rollback-test
sudo journalctl -u snap.rollback-test.firmware-updater.service -n 30
systemctl status snap.rollback-test.<service>.service

# Watch long-running test
watch -n30 'sudo tail -5 /var/snap/rollback-test/common/firmware.log'


================================================================================
                    FINAL SUMMARY FOR CUSTOMER
================================================================================

PROBLEM:
  Firmware update in post-refresh hook times out after ~10 minutes.

SOLUTION:
  Use oneshot daemon with extended start-timeout.

PROOF:
  - 15-minute oneshot SUCCESS: Tested, snap installs normally
  - 15-minute oneshot FAILURE: Tested, snap ROLLS BACK

IMPLEMENTATION:
  apps:
    firmware-updater:
      command: bin/flash-firmware.sh
      daemon: oneshot
      start-timeout: 20m  # Set longer than max flash time

RESULT:
  - Flash succeeds -> New snap version stays
  - Flash fails    -> Snap rolls back to previous version
  - Flash timeout  -> Snap rolls back to previous version


================================================================================
                              END OF REPORT
================================================================================
