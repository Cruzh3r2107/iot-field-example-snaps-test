#!/bin/bash
# Pre-refresh hook - runs BEFORE the snap is refreshed
# If this fails (exits non-zero), the refresh is ABORTED (not rolled back)

LOG_FILE="$SNAP_COMMON/hooks.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S.%3N')

echo "[$TIMESTAMP] === PRE-REFRESH HOOK ===" >> "$LOG_FILE"
echo "[$TIMESTAMP] Current version: $SNAP_VERSION, revision: $SNAP_REVISION" >> "$LOG_FILE"

# Check if configured to fail
PRE_REFRESH_FAIL=$(snapctl get pre-refresh-fail)
echo "[$TIMESTAMP] pre-refresh-fail config: '$PRE_REFRESH_FAIL'" >> "$LOG_FILE"

if [ "$PRE_REFRESH_FAIL" = "true" ]; then
    echo "[$TIMESTAMP] PRE-REFRESH HOOK FAILING" >> "$LOG_FILE"
    echo "[$TIMESTAMP] Result: Refresh will be ABORTED" >> "$LOG_FILE"
    exit 1
fi

echo "[$TIMESTAMP] Pre-refresh hook passed" >> "$LOG_FILE"
exit 0
