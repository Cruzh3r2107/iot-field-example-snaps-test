#!/bin/bash
# Post-refresh hook - runs AFTER the snap is refreshed
# If this fails (exits non-zero), the snap is ROLLED BACK to previous revision

LOG_FILE="$SNAP_COMMON/hooks.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S.%3N')

echo "[$TIMESTAMP] === POST-REFRESH HOOK ===" >> "$LOG_FILE"
echo "[$TIMESTAMP] New version: $SNAP_VERSION, revision: $SNAP_REVISION" >> "$LOG_FILE"

# Check if configured to fail
POST_REFRESH_FAIL=$(snapctl get post-refresh-fail)
echo "[$TIMESTAMP] post-refresh-fail config: '$POST_REFRESH_FAIL'" >> "$LOG_FILE"

if [ "$POST_REFRESH_FAIL" = "true" ]; then
    echo "[$TIMESTAMP] POST-REFRESH HOOK FAILING" >> "$LOG_FILE"
    echo "[$TIMESTAMP] Result: Snap will be ROLLED BACK" >> "$LOG_FILE"
    exit 1
fi

echo "[$TIMESTAMP] Post-refresh hook passed" >> "$LOG_FILE"
exit 0
